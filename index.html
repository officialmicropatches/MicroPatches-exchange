<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MicroPatches — Patch Exchange Program</title>

  <style>
    :root {
      --navy: #1a2235;
      --steel: #2e3f5c;
      --mid: #4a5a72;
      --gold: #c9a84c;
      --gold-light: #e8c97a;
      --offwhite: #f2ede6;
      --warm-gray: #b0a898;
      --text: #2a2a2a;
      --card-bg: #ffffff;
      --section-bg: #f7f3ed;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif;
      background: var(--offwhite);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      background: var(--navy);
      padding: 0;
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 40px,
        rgba(201,168,76,0.04) 40px,
        rgba(201,168,76,0.04) 41px
      );
      pointer-events: none;
    }

    .header-inner {
      max-width: 680px;
      margin: 0 auto;
      padding: 48px 24px 40px;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .badge {
      display: inline-block;
      background: var(--gold);
      color: var(--navy);
      font-family: 'Impact', 'Arial Narrow', sans-serif;
      font-size: 11px;
      letter-spacing: 3px;
      padding: 5px 14px;
      border-radius: 2px;
      margin-bottom: 18px;
    }

    h1 {
      font-family: 'Impact', 'Arial Narrow', sans-serif;
      font-size: clamp(48px, 10vw, 78px);
      color: #fff;
      line-height: 0.95;
      letter-spacing: 2px;
      margin-bottom: 6px;
    }

    h1 span { color: var(--gold); }

    .tagline {
      font-size: 15px;
      color: var(--warm-gray);
      font-weight: 300;
      letter-spacing: 0.5px;
      margin-top: 12px;
    }

    .divider {
      width: 48px;
      height: 2px;
      background: var(--gold);
      margin: 20px auto;
      opacity: 0.7;
    }

    .section { max-width: 680px; margin: 0 auto; padding: 48px 24px; }

    .section-label {
      font-family: 'Impact', 'Arial Narrow', sans-serif;
      font-size: 13px;
      letter-spacing: 4px;
      color: var(--gold);
      margin-bottom: 10px;
    }

    .section h2 {
      font-family: 'Impact', 'Arial Narrow', sans-serif;
      font-size: 36px;
      color: var(--navy);
      letter-spacing: 1px;
      margin-bottom: 28px;
    }

    .steps { display: grid; gap: 16px; }

    .step {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      background: var(--card-bg);
      border: 1px solid #e2ddd5;
      border-radius: 6px;
      padding: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

    .step-num {
      font-family: 'Impact', 'Arial Narrow', sans-serif;
      font-size: 32px;
      color: var(--gold);
      line-height: 1;
      min-width: 32px;
    }

    .step-content h3 { font-weight: 600; font-size: 15px; color: var(--navy); margin-bottom: 4px; }
    .step-content p { font-size: 14px; color: #5a5a5a; line-height: 1.6; }

    .patches-section {
      background: var(--section-bg);
      border-top: 1px solid #e0d9cf;
      border-bottom: 1px solid #e0d9cf;
    }

    .patches-inner { max-width: 680px; margin: 0 auto; padding: 48px 24px; }

    .patch-search {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d4cec6;
      border-radius: 6px;
      font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif;
      font-size: 14px;
      background: #fff;
      color: var(--text);
      margin-bottom: 24px;
      outline: none;
      transition: border-color 0.2s;
    }

    .patch-search:focus { border-color: var(--gold); }

    .patch-category { margin-bottom: 32px; }

    .patch-category h3 {
      font-family: 'Impact', 'Arial Narrow', sans-serif;
      font-size: 18px;
      letter-spacing: 2px;
      color: var(--mid);
      border-bottom: 1px solid #d4cec6;
      padding-bottom: 8px;
      margin-bottom: 14px;
    }

    .patch-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
    }

    .patch-card {
      background: var(--card-bg);
      border: 1px solid #e2ddd5;
      border-radius: 6px;
      padding: 12px 14px;
      font-size: 13px;
      color: var(--text);
      line-height: 1.4;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .patch-card:hover { border-color: var(--gold); box-shadow: 0 2px 8px rgba(201,168,76,0.15); }
    .patch-card.hidden { display: none; }

    .patch-state {
      font-size: 10px;
      letter-spacing: 1.5px;
      color: var(--warm-gray);
      text-transform: uppercase;
      display: block;
      margin-bottom: 2px;
    }

    .patch-name { font-weight: 600; color: var(--navy); display: block; }
    .patch-variant { font-size: 11px; color: var(--gold); margin-top: 2px; display: block; }

    /* ===== LUCKY DAY BANNER ===== */
    #luckyDay {
      display: none;
      background: linear-gradient(135deg, #1a2235 0%, #2e3f5c 100%);
      border: 2px solid var(--gold);
      border-radius: 10px;
      padding: 32px 24px;
      text-align: center;
      margin-top: 8px;
      animation: popIn 0.35s cubic-bezier(0.34,1.56,0.64,1) both;
    }

    @keyframes popIn {
      from { opacity:0; transform:scale(0.92); }
      to { opacity:1; transform:scale(1); }
    }

    #luckyDay .lucky-emoji { font-size: 44px; margin-bottom: 10px; }

    #luckyDay h3 {
      font-family: 'Impact', 'Arial Narrow', sans-serif;
      font-size: 34px;
      color: var(--gold-light);
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    #luckyDay p {
      font-size: 14px;
      color: var(--warm-gray);
      line-height: 1.7;
      max-width: 460px;
      margin: 0 auto 18px;
    }

    .queue-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 18px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .queue-badge.open {
      background: rgba(45,122,79,0.25);
      border: 1px solid #2d7a4f;
      color: #5ebd8a;
    }

    .queue-badge.pending {
      background: rgba(180,83,9,0.25);
      border: 1px solid #b45309;
      color: #f59e0b;
    }

    .queue-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .queue-badge.open .queue-dot { background: #5ebd8a; animation: blink 1.5s infinite; }
    .queue-badge.pending .queue-dot { background: #f59e0b; }

    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.35} }

    .waitlist-box {
      background: rgba(180,83,9,0.15);
      border: 1px solid rgba(180,83,9,0.5);
      border-radius: 6px;
      padding: 14px 16px;
      font-size: 13px;
      color: #f59e0b;
      text-align: left;
      margin: 0 auto 20px;
      max-width: 460px;
      line-height: 1.6;
    }

    .waitlist-box strong { color: #fbbf24; }

    .claim-btn {
      display: inline-block;
      background: var(--gold);
      color: var(--navy);
      font-family: 'Impact', 'Arial Narrow', sans-serif;
      font-size: 20px;
      letter-spacing: 2px;
      padding: 14px 36px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    .claim-btn:hover { background: var(--gold-light); transform: translateY(-2px); }
    .claim-btn:active { transform: translateY(0); }

    /* REWARD SECTION */
    .rewards { max-width: 680px; margin: 0 auto; padding: 48px 24px; }

    .reward-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .reward-card {
      background: var(--navy);
      color: #fff;
      border-radius: 8px;
      padding: 28px 20px;
      text-align: center;
    }

    .reward-icon { font-size: 36px; margin-bottom: 12px; }

    .reward-card h3 {
      font-family: 'Impact', 'Arial Narrow', sans-serif;
      font-size: 22px;
      letter-spacing: 1px;
      color: var(--gold-light);
      margin-bottom: 6px;
    }

    .reward-card p { font-size: 13px; color: var(--warm-gray); line-height: 1.5; }

    /* CONTACT FORM */
    .contact-section { background: var(--steel); }

    .contact-inner { max-width: 680px; margin: 0 auto; padding: 48px 24px; }
    .contact-inner .section-label { color: var(--gold-light); }

    .agency-notice {
      display: none;
      border-radius: 6px;
      padding: 13px 16px;
      font-size: 13px;
      margin-bottom: 20px;
      line-height: 1.6;
      border: 1px solid;
    }

    .agency-notice.open { background: rgba(45,122,79,0.15); border-color: #2d7a4f; color: #5ebd8a; }
    .agency-notice.pending { background: rgba(180,83,9,0.15); border-color: #b45309; color: #f59e0b; }
    .agency-notice.locked { background: rgba(100,0,0,0.15); border-color: #7f1d1d; color: #fca5a5; }

    .form-group { margin-bottom: 16px; }

    label {
      display: block;
      font-size: 12px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--warm-gray);
      margin-bottom: 6px;
      font-weight: 600;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 14px;
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 5px;
      color: #fff;
      font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.3); }
    input:focus, select:focus, textarea:focus { border-color: var(--gold); }
    select option { background: var(--steel); color: #fff; }
    textarea { resize: vertical; min-height: 90px; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

    .submit-btn {
      display: block;
      width: 100%;
      padding: 16px;
      background: var(--gold);
      color: var(--navy);
      border: none;
      border-radius: 5px;
      font-family: 'Impact', 'Arial Narrow', sans-serif;
      font-size: 20px;
      letter-spacing: 2px;
      cursor: pointer;
      margin-top: 8px;
      transition: background 0.2s, transform 0.1s, opacity 0.2s;
    }

    .submit-btn:hover:not(:disabled) { background: var(--gold-light); transform: translateY(-1px); }
    .submit-btn:active:not(:disabled) { transform: translateY(0); }
    .submit-btn:disabled { opacity: 0.45; cursor: not-allowed; }

    .form-note {
      font-size: 12px;
      color: rgba(255,255,255,0.35);
      margin-top: 14px;
      text-align: center;
      line-height: 1.6;
    }

    .success-msg {
      display: none;
      border-radius: 8px;
      padding: 28px 24px;
      text-align: center;
      font-size: 14px;
      margin-top: 16px;
      line-height: 1.8;
      border: 1px solid;
    }

    .success-msg.first { background: rgba(45,122,79,0.2); border-color: #2d7a4f; color: #5ebd8a; }
    .success-msg.waitlist { background: rgba(180,83,9,0.15); border-color: #b45309; color: #f59e0b; }

    .success-msg h4 {
      font-family: 'Impact', 'Arial Narrow', sans-serif;
      font-size: 26px;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    footer {
      background: var(--navy);
      text-align: center;
      padding: 28px 24px;
      font-size: 12px;
      color: rgba(255,255,255,0.3);
      letter-spacing: 0.5px;
      cursor: default;
      user-select: none;
    }

    footer a { color: var(--gold); text-decoration: none; }

    @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
    .fade-up { opacity:0; animation: fadeUp 0.5s ease forwards; }
    .fade-up:nth-child(1){animation-delay:0.1s}
    .fade-up:nth-child(2){animation-delay:0.2s}
    .fade-up:nth-child(3){animation-delay:0.3s}
    .fade-up:nth-child(4){animation-delay:0.4s}

    /* Photo upload in form */
    .photo-upload-area {
      border: 1.5px dashed rgba(255,255,255,0.2);
      border-radius: 5px;
      padding: 18px 14px;
      background: rgba(255,255,255,0.04);
      cursor: pointer;
      transition: border-color 0.2s;
      position: relative;
      text-align: center;
    }
    .photo-upload-area:hover { border-color: var(--gold); }
    .photo-upload-area input[type="file"] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer;
      width: 100%; height: 100%;
    }
    .photo-guidelines {
      font-size: 12px;
      color: rgba(255,255,255,0.35);
      line-height: 1.8;
      margin-bottom: 10px;
      text-align: left;
    }
    .photo-guidelines strong { color: rgba(255,255,255,0.55); }
    #photoPreviewThumb {
      width: 100%; max-width: 160px;
      border-radius: 4px; display: block;
      margin: 10px auto 0;
    }
    /* Inventory card photo */
    .patch-photo {
      width: 100%; border-radius: 3px;
      margin-top: 8px; display: block;
      object-fit: cover; aspect-ratio: 1 / 1;
      background: #f0ece4;
    }

    @media(max-width:480px){
      .form-row{grid-template-columns:1fr}
      .reward-options{grid-template-columns:1fr}
      .patch-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
    }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div class="badge">MICROPATCHES</div>
      <h1>PATCH<br><span>EXCHANGE</span></h1>
      <div class="divider"></div>
      <p class="tagline">Trade your agency patch for a custom keychain or magnet — 1 for 1.</p>
    </div>
  </header>

  <section class="section">
    <div class="section-label">THE PROGRAM</div>
    <h2>How It Works</h2>
    <div class="steps">
      <div class="step fade-up">
        <div class="step-num">01</div>
        <div class="step-content">
          <h3>Search Our Lineup</h3>
          <p>Type your agency in the search below. If we <strong>don't already have your patch</strong>, you're eligible for the exchange.</p>
        </div>
      </div>
      <div class="step fade-up">
        <div class="step-num">02</div>
        <div class="step-content">
          <h3>Claim Your Spot</h3>
          <p>Fill out the form to reserve your place. <strong>One primary spot per agency</strong> — if it's taken, you'll be added to the waitlist automatically.</p>
        </div>
      </div>
      <div class="step fade-up">
        <div class="step-num">03</div>
        <div class="step-content">
          <h3>Send Your Patch</h3>
          <p>After we confirm eligibility via email, mail us your agency patch. <strong>You only cover shipping to us</strong> — we'll cover shipping your keychain or magnet back to you. We finalize the exchange once the patch is in hand.</p>
        </div>
      </div>
      <div class="step fade-up">
        <div class="step-num">04</div>
        <div class="step-content">
          <h3>Get Your Reward</h3>
          <p>Choose a <strong>custom keychain</strong> or <strong>magnet</strong> in your agency's patch design — handmade at MicroPatches.</p>
        </div>
      </div>
    </div>
  </section>

  <section style="background: var(--section-bg); border-top: 1px solid #e0d9cf;">
    <div class="rewards">
      <div class="section-label">YOUR CHOICE</div>
      <h2 style="font-family:'Impact', 'Arial Narrow',sans-serif;font-size:36px;color:var(--navy);letter-spacing:1px;margin-bottom:4px;">Pick Your Reward</h2>
      <p style="font-size:14px;color:#5a5a5a;margin-bottom:0;">Each exchange earns you one of the following — made in your agency's patch design.</p>
      <div class="reward-options">
        <div class="reward-card">
          <div class="reward-icon">&#x1F511;</div>
          <h3>Keychain</h3>
          <p>3D printed, durable, full-color patch keychain you can carry every day.</p>
        </div>
        <div class="reward-card">
          <div class="reward-icon">&#x1F9F2;</div>
          <h3>Magnet</h3>
          <p>High-quality patch magnet — perfect for your locker, vehicle, or fridge.</p>
        </div>
      </div>
    </div>
  </section>

  <section class="patches-section">
    <div class="patches-inner">
      <div class="section-label">CURRENT INVENTORY</div>
      <h2 style="font-family:'Impact', 'Arial Narrow',sans-serif;font-size:36px;color:var(--navy);letter-spacing:1px;margin-bottom:6px;">Patches We Have</h2>
      <p style="font-size:14px;color:#5a5a5a;margin-bottom:24px;">If your agency is <strong>not listed below</strong>, you're eligible to participate.</p>

      <input type="text" class="patch-search" placeholder="Search your agency or state..." id="searchInput" oninput="filterPatches()">

      <div class="patch-category" id="cat-le">
        <h3>Law Enforcement</h3>
        <div class="patch-grid">
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">Chandler PD</span></div>
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">Chandler PD</span><span class="patch-variant">Retired</span></div>
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">Chandler PD</span><span class="patch-variant">Pink Patch Program</span></div>
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">Tempe PD</span></div>
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">Tempe PD</span><span class="patch-variant">Subdued</span></div>
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">Gilbert PD</span></div>
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">Phoenix PD</span></div>
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">Prescott PD</span></div>
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">AZ DPS</span></div>
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">Tucson PD</span></div>
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">Scottsdale PD</span><span class="patch-variant">Retired</span></div>
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">SCORE Jail</span></div>
          <div class="patch-card"><span class="patch-state">Arizona</span><span class="patch-name">Gila River Indian Police</span></div>
          <div class="patch-card"><span class="patch-state">Washington</span><span class="patch-name">Auburn PD</span></div>
          <div class="patch-card"><span class="patch-state">Washington</span><span class="patch-name">Auburn PD</span><span class="patch-variant">Retired</span></div>
          <div class="patch-card"><span class="patch-state">Washington</span><span class="patch-name">Pierce County Sheriff</span></div>
          <div class="patch-card"><span class="patch-state">Washington</span><span class="patch-name">Tacoma PD</span></div>
          <div class="patch-card"><span class="patch-state">Hawaii</span><span class="patch-name">Honolulu PD</span></div>
          <div class="patch-card"><span class="patch-state">Hawaii</span><span class="patch-name">Maui PD</span></div>
          <div class="patch-card"><span class="patch-state">California</span><span class="patch-name">San Jose PD</span></div>
          <div class="patch-card"><span class="patch-state">Nevada</span><span class="patch-name">Las Vegas Metro PD</span></div>
          <div class="patch-card"><span class="patch-state">New Mexico</span><span class="patch-name">Valencia County Sheriff</span></div>
          <div class="patch-card"><span class="patch-state">New Mexico</span><span class="patch-name">Albuquerque PD</span></div>
          <div class="patch-card"><span class="patch-state">New York</span><span class="patch-name">NYPD</span></div>
          <div class="patch-card"><span class="patch-state">Illinois</span><span class="patch-name">Chicago PD</span></div>
          <div class="patch-card"><span class="patch-state">New Hampshire</span><span class="patch-name">Portsmouth PD</span></div>
          <div class="patch-card"><span class="patch-state">Maine</span><span class="patch-name">Maine State Police</span></div>
          <div class="patch-card"><span class="patch-state">Federal</span><span class="patch-name">FBI SWAT</span></div>
        </div>
      </div>

      <div class="patch-category" id="cat-ems">
        <h3>EMS / Fire</h3>
        <div class="patch-grid">
          <div class="patch-card"><span class="patch-state">National</span><span class="patch-name">AMR (EMT)</span></div>
        </div>
      </div>

      <div class="patch-category" id="cat-mil">
        <h3>Military</h3>
        <div class="patch-grid">
          <div class="patch-card"><span class="patch-state">U.S. Army</span><span class="patch-name">82nd Airborne</span></div>
        </div>
      </div>

      <!-- LUCKY DAY BANNER -->
      <div id="luckyDay">
        <div class="lucky-emoji">&#x1F389;</div>
        <h3>It's Your Lucky Day!</h3>
        <p id="luckyMsg">We don't have your patch yet — which means you're eligible for the exchange. Claim your spot now and get a custom keychain or magnet of your agency's patch.</p>
        <div id="queueBadge" class="queue-badge open">
          <span class="queue-dot"></span>
          <span id="queueBadgeText">Spot Open — Be the First!</span>
        </div>
        <div id="waitlistBox" class="waitlist-box" style="display:none;">
          &#x26A0;&#xFE0F; <strong>Heads up:</strong> Someone has already submitted for this agency but we haven't received their patch yet. You can still fill out the form and be placed on the <strong>waitlist</strong>. If the primary submission falls through, we'll contact you next — no patch required from you until then.
        </div>
        <br>
        <button class="claim-btn" onclick="scrollToForm()">CLAIM YOUR SPOT &rarr;</button>
      </div>

    </div>
  </section>

  <section class="contact-section" id="formSection">
    <div class="contact-inner">
      <div class="section-label">GET STARTED</div>
      <h2 style="font-family:'Impact', 'Arial Narrow',sans-serif;font-size:36px;color:#fff;letter-spacing:1px;margin-bottom:18px;">Submit Your Exchange</h2>

      <div id="agencyNotice" class="agency-notice"></div>

      <form id="exchangeForm">
        <div class="form-row">
          <div class="form-group">
            <label>First Name</label>
            <input type="text" id="firstName" name="firstName" placeholder="John" required>
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" id="lastName" name="lastName" placeholder="Smith" required>
          </div>
        </div>

        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="emailInput" name="email" placeholder="you@example.com" required>
        </div>

        <div class="form-group">
          <label>Agency / Department Name</label>
          <input type="text" id="agencyInput" name="agency" placeholder="e.g. Mesa Police Department" required oninput="checkAgency()">
        </div>

        <div class="form-group">
          <label>State</label>
          <input type="text" id="stateInput" name="state" placeholder="e.g. Arizona" required>
        </div>

        <div class="form-group">
          <label>I Want In Exchange</label>
          <select id="rewardSelect" name="reward" required>
            <option value="" disabled selected>Select your reward...</option>
            <option>Keychain — Agency Patch Design</option>
            <option>Magnet — Agency Patch Design</option>
          </select>
        </div>

        <div class="form-group">
          <label>Anything else we should know?</label>
          <textarea id="notesInput" name="notes" placeholder="Notes, questions, patch details, etc."></textarea>
        </div>

        <div class="form-group">
          <label>Photo of Your Patch <span style="color:var(--warm-gray);font-weight:400;text-transform:none;letter-spacing:0;">(optional, but very helpful)</span></label>
          <p class="photo-guidelines">
            <strong>Tips for a great shot:</strong><br>
            &bull; Lay the patch flat on a plain, light-colored surface<br>
            &bull; Use natural daylight or a bright lamp &mdash; avoid direct flash<br>
            &bull; Fill the frame with the patch and keep it in sharp focus<br>
            &bull; JPEG, PNG, or WebP &mdash; max 10&nbsp;MB
          </p>
          <div class="photo-upload-area" id="photoUploadArea">
            <input type="file" id="patchPhotoInput" accept="image/jpeg,image/png,image/webp">
            <span id="photoUploadLabel" style="color:rgba(255,255,255,0.4);font-size:13px;">&#x1F4F7;&nbsp; Tap to attach a photo of your patch</span>
            <img id="photoPreviewThumb" style="display:none;" alt="Patch preview">
          </div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">SUBMIT EXCHANGE REQUEST</button>
        <p class="form-note">
          After submitting, we'll email you within 24&ndash;48 hours with confirmation and our mailing address.
          <strong>Do NOT send your patch until you've heard from us.</strong><br><br>
          &#x1F4E6; <strong>Shipping breakdown:</strong> You cover postage to send your patch to us — we cover shipping your keychain or magnet back to you. Totally free on our end.
        </p>
      </form>

      <div class="success-msg" id="successMsg"></div>
    </div>
  </section>

  <footer id="footerEl">
    <p>&copy; 2025 MicroPatches &middot; All Rights Reserved</p>
    <p style="margin-top:6px;"><a href="https://instagram.com/micropatches" target="_blank">@MicroPatches</a> on Instagram</p>
  </footer>

  <script type="module">
    import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, push, get, set, update, remove }
                               from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL }
                               from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

    // ── Firebase initialisation ───────────────────────────────────────────────
    const firebaseConfig = {
      apiKey:            "AIzaSyDkNCYz7DXKF2Ku8B4FfN1gXdVV3P3B2YE",
      authDomain:        "micropatches-exchange.firebaseapp.com",
      databaseURL:       "https://micropatches-exchange-default-rtdb.firebaseio.com",
      projectId:         "micropatches-exchange",
      storageBucket:     "micropatches-exchange.firebasestorage.app",
      messagingSenderId: "953111257361",
      appId:             "1:953111257361:web:e18c2c403e222cf97b6cb0"
    };

    const app     = initializeApp(firebaseConfig);
    const db      = getDatabase(app);
    const storage = getStorage(app);

    // ── Utilities ─────────────────────────────────────────────────────────────

    /** Convert an agency name to a safe Firebase key. */
    function sanitizeKey(name) {
      return name.toLowerCase().trim()
        .replace(/[.#$[\]/]/g, '_')
        .replace(/\s+/g, '_')
        .replace(/_+/g, '_')
        .substring(0, 100);
    }

    /** Escape HTML for safe insertion into admin panel. */
    function esc(str) {
      return String(str ?? '')
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // ── Image utilities ───────────────────────────────────────────────────────

    /** Resize + compress an image File to a JPEG Blob (max 1400px, q=0.82). */
    function compressImage(file) {
      return new Promise(function (resolve) {
        var img = new Image();
        var url = URL.createObjectURL(file);
        img.onload = function () {
          URL.revokeObjectURL(url);
          var maxDim = 1400, q = 0.82;
          var scale  = Math.min(1, maxDim / Math.max(img.width, img.height));
          var canvas = document.createElement('canvas');
          canvas.width  = Math.round(img.width  * scale);
          canvas.height = Math.round(img.height * scale);
          canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(resolve, 'image/jpeg', q);
        };
        img.src = url;
      });
    }

    /** Compress a file, upload to Firebase Storage path, return download URL. */
    async function uploadToStorage(file, path) {
      var blob    = await compressImage(file);
      var fileRef = sRef(storage, path);
      await uploadBytes(fileRef, blob, { contentType: 'image/jpeg' });
      return getDownloadURL(fileRef);
    }

    // ── Inventory photo loader ────────────────────────────────────────────────

    /**
     * Fetch all agency photo URLs from Firebase and inject them into matching
     * patch cards in the inventory. Key formula:
     *   sanitizeKey(patchName + (variant ? ' ' + variant : ''))
     */
    async function loadAgencyPhotos() {
      try {
        var snap = await get(ref(db, 'agencyPhotos'));
        if (!snap.exists()) return;
        var photos = snap.val();
        document.querySelectorAll('.patch-card').forEach(function (card) {
          var name    = (card.querySelector('.patch-name')?.textContent    || '').trim();
          var variant = (card.querySelector('.patch-variant')?.textContent || '').trim();
          var key     = sanitizeKey(variant ? name + ' ' + variant : name);
          if (photos[key]) {
            // Remove old photo if refreshing
            var old = card.querySelector('.patch-photo');
            if (old) old.remove();
            var img    = document.createElement('img');
            img.src    = photos[key];
            img.alt    = name;
            img.className = 'patch-photo';
            img.loading   = 'lazy';
            card.appendChild(img);
          }
        });
      } catch (err) {
        console.warn('loadAgencyPhotos error:', err);
      }
    }

    // Load photos on page init
    loadAgencyPhotos();

    // ── Photo input preview ───────────────────────────────────────────────────

    document.getElementById('patchPhotoInput').addEventListener('change', function () {
      var file  = this.files[0];
      var label = document.getElementById('photoUploadLabel');
      var thumb = document.getElementById('photoPreviewThumb');
      if (!file) return;
      var reader = new FileReader();
      reader.onload = function (e) {
        thumb.src          = e.target.result;
        thumb.style.display = 'block';
        label.textContent   = '\u2713 ' + file.name;
      };
      reader.readAsDataURL(file);
    });

    // ── Queue status helpers ──────────────────────────────────────────────────

    /**
     * Exact key lookup — used by the form's checkAgency() where the user
     * has typed the full agency name they intend to submit.
     * Returns 'open' | 'pending' | 'locked'.
     */
    async function getAgencyStatus(agencyName) {
      if (!agencyName || agencyName.length < 2) return 'open';
      try {
        const snap = await get(ref(db, 'queue/' + sanitizeKey(agencyName)));
        if (!snap.exists()) return 'open';
        return snap.val().status || 'pending';
      } catch (err) {
        console.warn('Firebase read error:', err);
        return 'open';
      }
    }

    /**
     * Partial-match scan — used by the lucky day banner where the user may
     * have typed only part of an agency name (e.g. "denver" matching
     * "Denver Colorado PD"). Loads all queue entries and returns the most
     * restrictive status found among any partial matches.
     * Returns 'open' | 'pending' | 'locked'.
     */
    async function getAgencyStatusBySearch(searchTerm) {
      if (!searchTerm || searchTerm.length < 2) return 'open';
      try {
        const snap = await get(ref(db, 'queue'));
        if (!snap.exists()) return 'open';
        const term  = searchTerm.toLowerCase();
        let   found = 'open';
        for (const entry of Object.values(snap.val())) {
          const name = (entry.agencyName || '').toLowerCase();
          if (name.includes(term) || term.includes(name)) {
            const s = entry.status || 'pending';
            if (s === 'locked')  { found = 'locked';  break; }
            if (s === 'pending')   found = 'pending';
          }
        }
        return found;
      } catch (err) {
        console.warn('Firebase read error:', err);
        return 'open';
      }
    }

    // ── Lucky Day Banner ──────────────────────────────────────────────────────

    /** Refresh the banner badge using a partial search scan of all queue entries. */
    async function updateLuckyBanner(searchTerm) {
      const badge    = document.getElementById('queueBadge');
      const badgeTxt = document.getElementById('queueBadgeText');
      const wBox     = document.getElementById('waitlistBox');
      const status   = await getAgencyStatusBySearch(searchTerm);

      if (status === 'open') {
        badge.className      = 'queue-badge open';
        badgeTxt.textContent = 'Spot Open \u2014 Be the First!';
        wBox.style.display   = 'none';
      } else {
        badge.className      = 'queue-badge pending';
        badgeTxt.textContent = status === 'locked'
          ? 'Waitlist \u2014 Exchange In Progress'
          : 'Waitlist \u2014 Primary Spot Taken';
        wBox.style.display   = 'block';
      }
    }

    // ── Patch inventory search / filter ───────────────────────────────────────

    window.filterPatches = function () {
      const q     = document.getElementById('searchInput').value.trim().toLowerCase();
      const cards = document.querySelectorAll('.patch-card');
      let anyVisible = false;

      cards.forEach(function (card) {
        var match = q && card.textContent.toLowerCase().includes(q);
        if (!q || match) {
          card.classList.remove('hidden');
          if (q) anyVisible = true;
        } else {
          card.classList.add('hidden');
        }
      });

      document.querySelectorAll('.patch-category').forEach(function (cat) {
        if (!q) { cat.style.display = ''; return; }
        cat.style.display = cat.querySelectorAll('.patch-card:not(.hidden)').length > 0 ? '' : 'none';
      });

      var lucky = document.getElementById('luckyDay');
      // Show banner only when there IS a query, it's 2+ chars, and nothing matched
      if (!q || q.length < 2 || anyVisible) {
        lucky.style.display = 'none';
        return;
      }

      lucky.style.display = 'block';
      updateLuckyBanner(document.getElementById('searchInput').value.trim());
    };

    // ── Form — agency real-time check (debounced) ─────────────────────────────

    var _checkTimer = null;

    window.checkAgency = function () {
      clearTimeout(_checkTimer);
      _checkTimer = setTimeout(async function () {
        var agency = document.getElementById('agencyInput').value.trim();
        var notice = document.getElementById('agencyNotice');
        var btn    = document.getElementById('submitBtn');

        if (agency.length < 3) {
          notice.style.display = 'none';
          btn.textContent      = 'SUBMIT EXCHANGE REQUEST';
          btn.disabled         = false;
          return;
        }

        var status = await getAgencyStatus(agency);
        notice.style.display = 'block';

        if (status === 'open') {
          notice.className = 'agency-notice open';
          notice.innerHTML = '\u2705 <strong>Spot available!</strong> You will be the first submission for this agency.';
          btn.textContent  = 'CLAIM PRIMARY SPOT \u2192';
          btn.disabled     = false;
        } else if (status === 'pending') {
          notice.className = 'agency-notice pending';
          notice.innerHTML = '\u26A0\uFE0F <strong>Primary spot taken.</strong> Submitting will add you to the <strong>waitlist</strong> for this agency.';
          btn.textContent  = 'JOIN WAITLIST \u2192';
          btn.disabled     = false;
        } else {
          notice.className = 'agency-notice locked';
          notice.innerHTML = '\uD83D\uDD12 <strong>Submissions closed.</strong> This agency\'s patch has been received and the exchange is in progress.';
          btn.textContent  = 'SUBMISSIONS CLOSED';
          btn.disabled     = true;
        }
      }, 400);
    };

    // ── Scroll-to-form (Claim button) ─────────────────────────────────────────

    window.scrollToForm = function () {
      var search = document.getElementById('searchInput').value.trim();
      if (search.length >= 2) {
        document.getElementById('agencyInput').value = search;
        window.checkAgency();
      }
      document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
      setTimeout(function () { document.getElementById('agencyInput').focus(); }, 650);
    };

    // ── Form submission ───────────────────────────────────────────────────────

    document.getElementById('exchangeForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      var btn        = document.getElementById('submitBtn');
      var successMsg = document.getElementById('successMsg');
      var origLabel  = btn.textContent;

      btn.textContent = 'SUBMITTING\u2026';
      btn.disabled    = true;

      var firstName = document.getElementById('firstName').value.trim();
      var lastName  = document.getElementById('lastName').value.trim();
      var email     = document.getElementById('emailInput').value.trim();
      var agency    = document.getElementById('agencyInput').value.trim();
      var state     = document.getElementById('stateInput').value.trim();
      var reward    = document.getElementById('rewardSelect').value;
      var notes     = document.getElementById('notesInput').value.trim();
      var agencyKey = sanitizeKey(agency);

      try {
        // Re-check status right before writing to guard against race conditions
        var currentStatus = await getAgencyStatus(agency);

        if (currentStatus === 'locked') {
          alert('This agency\'s exchange is already in progress. New submissions are not being accepted.');
          btn.textContent = 'SUBMISSIONS CLOSED';
          return;
        }

        var isWaitlist = (currentStatus === 'pending');
        var position   = isWaitlist ? 'WAITLIST' : 'PRIMARY';

        // Upload patch photo if provided
        var photoUrl   = null;
        var photoFile  = document.getElementById('patchPhotoInput').files[0];
        if (photoFile) {
          btn.textContent = 'UPLOADING PHOTO\u2026';
          try {
            photoUrl = await uploadToStorage(
              photoFile,
              'patch-photos/submissions/' + agencyKey + '/' + Date.now()
            );
          } catch (upErr) {
            console.warn('Photo upload failed (non-fatal):', upErr);
          }
        }

        var submission = {
          firstName: firstName,
          lastName:  lastName,
          email:     email,
          agency:    agency,
          state:     state,
          reward:    reward,
          notes:     notes,
          position:  position,
          photoUrl:  photoUrl,
          timestamp: Date.now()
        };

        // Write to Firebase
        if (!isWaitlist) {
          // Claim the primary spot
          await set(ref(db, 'queue/' + agencyKey), {
            agencyName: agency,
            status:     'pending',
            primary:    submission
          });
        } else {
          // Append to waitlist
          await push(ref(db, 'queue/' + agencyKey + '/waitlist'), submission);
        }

        // Email notification via Formspree (non-fatal if it fails)
        try {
          await fetch('https://formspree.io/f/mqednono', {
            method:  'POST',
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({
              _subject:    '[' + position + '] Exchange Request: ' + agency,
              name:        firstName + ' ' + lastName,
              email:       email,
              agency:      agency,
              state:       state,
              reward:      reward,
              notes:       notes,
              position:    position,
              photoUrl:    photoUrl || '(none)',
              submittedAt: new Date().toISOString()
            })
          });
        } catch (fsErr) {
          console.warn('Formspree notification failed (non-fatal):', fsErr);
        }

        // Show success
        document.getElementById('exchangeForm').style.display = 'none';
        successMsg.style.display = 'block';
        successMsg.className     = 'success-msg ' + (isWaitlist ? 'waitlist' : 'first');

        if (!isWaitlist) {
          successMsg.innerHTML =
            '<h4>\uD83C\uDF89 You\'re In!</h4>' +
            '<p>You\'ve claimed the <strong>primary spot</strong> for <strong>' + esc(agency) + '</strong>.<br>' +
            'We\'ll email <strong>' + esc(email) + '</strong> within 24\u201348 hours with our mailing address.<br><br>' +
            '<strong>Do NOT send your patch until you hear from us.</strong></p>';
        } else {
          successMsg.innerHTML =
            '<h4>\uD83D\uDCCB You\'re on the Waitlist!</h4>' +
            '<p>You\'ve been added to the <strong>waitlist</strong> for <strong>' + esc(agency) + '</strong>.<br>' +
            'If the primary falls through, we\'ll contact you at <strong>' + esc(email) + '</strong> next.<br><br>' +
            '<strong>No action needed from you until then.</strong></p>';
        }

      } catch (err) {
        console.error('Submission error:', err);
        btn.textContent = origLabel;
        btn.disabled    = false;
        alert('There was a problem submitting your request. Please try again.');
      }
    });

    // ── Admin Panel ───────────────────────────────────────────────────────────

    var _footerTaps  = 0;
    var _footerTimer = null;

    document.getElementById('footerEl').addEventListener('click', function () {
      _footerTaps++;
      clearTimeout(_footerTimer);
      _footerTimer = setTimeout(function () { _footerTaps = 0; }, 2500);

      if (_footerTaps >= 5) {
        _footerTaps = 0;
        var pw = prompt('Admin Password:');
        if (pw === null) return;
        if (pw === 'Abrnpd216!!') {
          openAdminPanel();
        } else {
          alert('Incorrect password.');
        }
      }
    });

    // These must be on window because they're called from dynamically generated onclick attrs
    window.adminMarkReceived = async function (key) {
      if (!confirm('Mark this agency\'s patch as received? This locks the queue for new submissions.')) return;
      try {
        await update(ref(db, 'queue/' + key), { status: 'locked', receivedAt: Date.now() });
        await renderAdminData();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };

    window.adminClearQueue = async function (key) {
      if (!confirm('Clear the entire queue for this agency? This cannot be undone.')) return;
      try {
        await remove(ref(db, 'queue/' + key));
        await renderAdminData();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };

    function openAdminPanel() {
      var existing = document.getElementById('adminPanel');
      if (existing) existing.remove();

      var panel = document.createElement('div');
      panel.id  = 'adminPanel';
      Object.assign(panel.style, {
        position:   'fixed',
        top:        '0',
        left:       '0',
        right:      '0',
        bottom:     '0',
        background: 'rgba(8,12,22,0.97)',
        zIndex:     '9999',
        overflowY:  'auto',
        padding:    '24px',
        fontFamily: "-apple-system,'Helvetica Neue',Arial,sans-serif"
      });

      panel.innerHTML =
        '<div style="max-width:740px;margin:0 auto;">' +
          '<div style="display:flex;justify-content:space-between;align-items:center;' +
                      'border-bottom:1px solid #1e293b;padding-bottom:16px;margin-bottom:24px;">' +
            '<div>' +
              '<h2 style="color:#c9a84c;font-family:Impact,sans-serif;font-size:24px;' +
                         'letter-spacing:2px;margin-bottom:3px;">ADMIN PANEL</h2>' +
              '<p style="color:#334155;font-size:12px;">MicroPatches Exchange \u2014 Queue Manager</p>' +
            '</div>' +
            '<button onclick="document.getElementById(\'adminPanel\').remove()"' +
              ' style="background:#450a0a;color:#fca5a5;border:1px solid #7f1d1d;' +
                      'padding:8px 16px;border-radius:4px;cursor:pointer;font-size:13px;font-weight:600;">' +
              '\u2715 CLOSE' +
            '</button>' +
          '</div>' +
          '<div style="display:flex;gap:8px;margin-bottom:20px;">' +
            '<button id="adminTabQueue" onclick="renderAdminData()"' +
              ' style="background:#c9a84c22;color:#c9a84c;border:1px solid #c9a84c55;' +
                      'padding:7px 18px;border-radius:4px;cursor:pointer;font-size:12px;' +
                      'font-weight:700;letter-spacing:1px;">' +
              'QUEUE' +
            '</button>' +
            '<button id="adminTabPhotos" onclick="renderPhotoManager()"' +
              ' style="background:transparent;color:#64748b;border:1px solid #1e293b;' +
                      'padding:7px 18px;border-radius:4px;cursor:pointer;font-size:12px;' +
                      'font-weight:700;letter-spacing:1px;">' +
              'AGENCY PHOTOS' +
            '</button>' +
          '</div>' +
          '<div id="adminContent" style="color:#f2ede6;">' +
            '<p style="color:#334155;">Loading queue data\u2026</p>' +
          '</div>' +
        '</div>';

      document.body.appendChild(panel);
      renderAdminData();
    }

    async function renderAdminData() {
      var content = document.getElementById('adminContent');
      if (!content) return;
      content.innerHTML = '<p style="color:#334155;">Loading\u2026</p>';

      try {
        var snap = await get(ref(db, 'queue'));

        if (!snap.exists()) {
          content.innerHTML = '<p style="color:#475569;text-align:center;padding:48px 0;">Queue is empty \u2014 no submissions yet.</p>';
          return;
        }

        var queue   = snap.val();
        var entries = Object.entries(queue);

        if (entries.length === 0) {
          content.innerHTML = '<p style="color:#475569;text-align:center;padding:48px 0;">Queue is empty.</p>';
          return;
        }

        var statusMeta = {
          pending: { color: '#f59e0b', label: 'PENDING' },
          locked:  { color: '#ef4444', label: 'RECEIVED / LOCKED' }
        };

        var html = '<p style="color:#475569;font-size:13px;margin-bottom:16px;">' +
          entries.length + ' agenc' + (entries.length === 1 ? 'y' : 'ies') + ' in queue</p>';

        for (var i = 0; i < entries.length; i++) {
          var key      = entries[i][0];
          var entry    = entries[i][1];
          var status   = entry.status || 'pending';
          var meta     = statusMeta[status] || statusMeta.pending;
          var primary  = entry.primary  || {};
          var waitlist = Object.values(entry.waitlist || {});

          var markBtn = status !== 'locked'
            ? '<button onclick="adminMarkReceived(\'' + esc(key) + '\')"' +
              ' style="background:#064e3b;color:#6ee7b7;border:1px solid #065f46;' +
                      'padding:7px 13px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">' +
              '\u2713 Mark Received</button>'
            : '';

          var clearBtn =
            '<button onclick="adminClearQueue(\'' + esc(key) + '\')"' +
            ' style="background:#450a0a;color:#fca5a5;border:1px solid #7f1d1d;' +
                    'padding:7px 13px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">' +
            '\uD83D\uDDD1 Clear Queue</button>';

          var photoThumb = primary.photoUrl
            ? '<a href="' + esc(primary.photoUrl) + '" target="_blank" style="flex-shrink:0;">' +
                '<img src="' + esc(primary.photoUrl) + '" alt="Patch photo"' +
                  ' style="width:80px;height:80px;object-fit:cover;border-radius:5px;' +
                          'border:1px solid #1e3a5f;display:block;">' +
              '</a>'
            : '';

          var primaryHtml = primary.firstName
            ? '<div style="display:flex;gap:12px;align-items:flex-start;">' +
                photoThumb +
                '<div>' +
                  '<p style="color:#f1f5f9;font-size:14px;margin-bottom:3px;"><strong>' +
                    esc(primary.firstName) + ' ' + esc(primary.lastName) + '</strong></p>' +
                  '<p style="color:#94a3b8;font-size:13px;margin-bottom:2px;">\uD83D\uDCE7 ' + esc(primary.email) + '</p>' +
                  '<p style="color:#94a3b8;font-size:13px;margin-bottom:2px;">\uD83D\uDCCD ' +
                    esc(primary.state) + ' &nbsp;&middot;&nbsp; \uD83C\uDF81 ' + esc(primary.reward) + '</p>' +
                  (primary.notes ? '<p style="color:#64748b;font-size:12px;margin-bottom:2px;">\uD83D\uDCDD ' + esc(primary.notes) + '</p>' : '') +
                  '<p style="color:#1e293b;font-size:11px;margin-top:4px;">' +
                    (primary.timestamp ? new Date(primary.timestamp).toLocaleString() : '') + '</p>' +
                '</div>' +
              '</div>'
            : '<p style="color:#334155;font-size:13px;">No primary data on record.</p>';

          var waitlistHtml = '';
          if (waitlist.length > 0) {
            var wItems = waitlist.map(function (w, wi) {
              return '<div style="background:#080d18;border-radius:4px;padding:10px;margin-bottom:8px;">' +
                '<p style="color:#f1f5f9;font-size:13px;margin-bottom:2px;">' +
                  (wi + 1) + '. <strong>' + esc(w.firstName) + ' ' + esc(w.lastName) + '</strong></p>' +
                '<p style="color:#94a3b8;font-size:12px;">\uD83D\uDCE7 ' + esc(w.email) +
                  ' &nbsp;&middot;&nbsp; \uD83D\uDCCD ' + esc(w.state) +
                  ' &nbsp;&middot;&nbsp; \uD83C\uDF81 ' + esc(w.reward) + '</p>' +
                (w.notes ? '<p style="color:#64748b;font-size:12px;margin-top:2px;">\uD83D\uDCDD ' + esc(w.notes) + '</p>' : '') +
                '<p style="color:#1e293b;font-size:11px;margin-top:3px;">' +
                  (w.timestamp ? new Date(w.timestamp).toLocaleString() : '') + '</p>' +
              '</div>';
            }).join('');

            waitlistHtml =
              '<div style="border-top:1px solid #1e293b;padding-top:12px;margin-top:12px;">' +
                '<p style="color:#f59e0b;font-size:11px;letter-spacing:1.5px;font-weight:700;margin-bottom:8px;">' +
                  'WAITLIST (' + waitlist.length + ')</p>' +
                wItems +
              '</div>';
          }

          html +=
            '<div style="background:#0f172a;border:1px solid #1e293b;' +
                        'border-left:3px solid ' + meta.color + ';border-radius:8px;' +
                        'padding:18px;margin-bottom:14px;">' +
              '<div style="display:flex;justify-content:space-between;align-items:flex-start;' +
                          'flex-wrap:wrap;gap:10px;margin-bottom:14px;">' +
                '<div>' +
                  '<h3 style="color:#e8c97a;font-size:17px;margin-bottom:6px;">' + esc(entry.agencyName || key) + '</h3>' +
                  '<span style="background:' + meta.color + '22;color:' + meta.color + ';' +
                               'border:1px solid ' + meta.color + '55;padding:3px 10px;' +
                               'border-radius:12px;font-size:11px;font-weight:700;letter-spacing:1px;">' +
                    meta.label +
                  '</span>' +
                '</div>' +
                '<div style="display:flex;gap:8px;flex-wrap:wrap;">' + markBtn + clearBtn + '</div>' +
              '</div>' +
              '<div style="border-top:1px solid #1e293b;padding-top:12px;">' +
                '<p style="color:#c9a84c;font-size:11px;letter-spacing:1.5px;font-weight:700;margin-bottom:8px;">PRIMARY</p>' +
                primaryHtml +
              '</div>' +
              waitlistHtml +
            '</div>';
        }

        content.innerHTML = html;

      } catch (err) {
        console.error('Admin load error:', err);
        content.innerHTML = '<p style="color:#fca5a5;">Error loading queue: ' + esc(err.message) + '</p>';
      }
    }

    // ── Agency Photo Manager ───────────────────────────────────────────────────

    window.adminUploadPhoto = async function (key, name) {
      var input = document.createElement('input');
      input.type   = 'file';
      input.accept = 'image/jpeg,image/png,image/webp';
      input.onchange = async function () {
        var file = input.files[0];
        if (!file) return;
        var btn = document.getElementById('photoBtn_' + key);
        if (btn) { btn.textContent = 'Uploading…'; btn.disabled = true; }
        try {
          var url = await uploadToStorage(file, 'patch-photos/inventory/' + key);
          await set(ref(db, 'agencyPhotos/' + key), url);
          // refresh inventory card on-page
          document.querySelectorAll('.patch-card').forEach(function (card) {
            var cName    = (card.querySelector('.patch-name')?.textContent    || '').trim();
            var cVariant = (card.querySelector('.patch-variant')?.textContent || '').trim();
            var cKey     = sanitizeKey(cVariant ? cName + ' ' + cVariant : cName);
            if (cKey === key) {
              var old = card.querySelector('.patch-photo');
              if (old) old.remove();
              var img = document.createElement('img');
              img.src = url; img.alt = name;
              img.className = 'patch-photo'; img.loading = 'lazy';
              card.appendChild(img);
            }
          });
          // re-render photo manager to show updated thumbnail
          renderPhotoManager();
        } catch (err) {
          alert('Upload failed: ' + err.message);
          if (btn) { btn.textContent = 'Upload Photo'; btn.disabled = false; }
        }
      };
      input.click();
    };

    window.renderPhotoManager = async function () {
      renderPhotoManager();
    };

    async function renderPhotoManager() {
      // highlight active tab
      var qTab = document.getElementById('adminTabQueue');
      var pTab = document.getElementById('adminTabPhotos');
      if (qTab) Object.assign(qTab.style, { background:'transparent', color:'#64748b', borderColor:'#1e293b' });
      if (pTab) Object.assign(pTab.style, { background:'#c9a84c22', color:'#c9a84c', borderColor:'#c9a84c55' });

      var content = document.getElementById('adminContent');
      if (!content) return;
      content.innerHTML = '<p style="color:#334155;">Loading agency photos\u2026</p>';

      try {
        // Gather all agencies from on-page inventory cards
        var cards = document.querySelectorAll('.patch-card');
        var agencies = [];
        cards.forEach(function (card) {
          var name    = (card.querySelector('.patch-name')?.textContent    || '').trim();
          var variant = (card.querySelector('.patch-variant')?.textContent || '').trim();
          if (!name) return;
          var label   = variant ? name + ' (' + variant + ')' : name;
          var key     = sanitizeKey(variant ? name + ' ' + variant : name);
          agencies.push({ key: key, label: label });
        });

        // Remove duplicates by key
        var seen = {};
        agencies = agencies.filter(function (a) {
          if (seen[a.key]) return false;
          seen[a.key] = true;
          return true;
        });

        // Load existing photos from Firebase
        var photoSnap = await get(ref(db, 'agencyPhotos'));
        var photos    = photoSnap.exists() ? photoSnap.val() : {};

        // Search filter
        var searchId = 'photoSearch_' + Date.now();
        var html =
          '<p style="color:#475569;font-size:13px;margin-bottom:16px;">' +
            agencies.length + ' agenc' + (agencies.length === 1 ? 'y' : 'ies') + ' in inventory</p>' +
          '<input id="' + searchId + '" type="text" placeholder="Filter agencies\u2026"' +
            ' oninput="(function(){' +
              'var term=document.getElementById(\'' + searchId + '\').value.toLowerCase();' +
              'document.querySelectorAll(\'.pmRow\').forEach(function(r){' +
                'r.style.display=r.dataset.label.toLowerCase().includes(term)?\'\':\' none\';' +
              '})' +
            '})()"' +
            ' style="width:100%;box-sizing:border-box;background:#0f172a;color:#f2ede6;' +
                    'border:1px solid #1e293b;border-radius:5px;padding:9px 12px;' +
                    'font-size:14px;margin-bottom:18px;">' +
          '<div>';

        agencies.forEach(function (a) {
          var imgHtml = photos[a.key]
            ? '<img src="' + esc(photos[a.key]) + '" alt="' + esc(a.label) + '"' +
                ' style="width:64px;height:64px;object-fit:cover;border-radius:4px;' +
                        'border:1px solid #1e3a5f;flex-shrink:0;">'
            : '<div style="width:64px;height:64px;border-radius:4px;border:1px dashed #334155;' +
                          'flex-shrink:0;display:flex;align-items:center;justify-content:center;' +
                          'color:#334155;font-size:10px;text-align:center;line-height:1.3;">NO<br>PHOTO</div>';

          html +=
            '<div class="pmRow" data-label="' + esc(a.label) + '"' +
              ' style="display:flex;align-items:center;gap:14px;' +
                      'background:#0f172a;border:1px solid #1e293b;border-radius:7px;' +
                      'padding:12px 14px;margin-bottom:10px;">' +
              imgHtml +
              '<div style="flex:1;min-width:0;">' +
                '<p style="color:#f1f5f9;font-size:14px;margin-bottom:6px;' +
                          'white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' +
                  esc(a.label) +
                '</p>' +
                '<button id="photoBtn_' + esc(a.key) + '"' +
                  ' onclick="adminUploadPhoto(\'' + esc(a.key) + '\',\'' + esc(a.label) + '\')"' +
                  ' style="background:#1e3a5f;color:#93c5fd;border:1px solid #1e40af;' +
                          'padding:6px 14px;border-radius:4px;cursor:pointer;' +
                          'font-size:12px;font-weight:600;">' +
                  (photos[a.key] ? '\uD83D\uDD04 Replace Photo' : '\uD83D\uDCF7 Upload Photo') +
                '</button>' +
              '</div>' +
            '</div>';
        });

        html += '</div>';
        content.innerHTML = html;

      } catch (err) {
        content.innerHTML = '<p style="color:#fca5a5;">Error: ' + esc(err.message) + '</p>';
      }
    }

    // Re-highlight queue tab as active on initial render
    var _origRenderAdmin = renderAdminData;
    renderAdminData = async function () {
      var qTab = document.getElementById('adminTabQueue');
      var pTab = document.getElementById('adminTabPhotos');
      if (qTab) Object.assign(qTab.style, { background:'#c9a84c22', color:'#c9a84c', borderColor:'#c9a84c55' });
      if (pTab) Object.assign(pTab.style, { background:'transparent', color:'#64748b', borderColor:'#1e293b' });
      return _origRenderAdmin();
    };

  </script>
</body>
</html>
